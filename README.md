# AI Agent 量化交易项目 (v2.0) - 详细说明文档

## 1. 项目概述：打造您的智能交易助手

本项目旨在构建一个**自适应的 AI Agent 量化交易引擎**。想象一下，您无需复杂的编程知识，只需通过简单的自然语言指令，就能让一个智能机器人帮助您分析市场、制定交易策略，并根据您的风险偏好进行自动交易。

**我们的最终目标是：**

*   **环境感知**：Agent 能够“看懂”市场数据，例如股票价格、技术指标等。
*   **策略生成**：根据市场情况和您的指令，自动生成（或调整）交易策略，例如对冲、套利等方案。
*   **风险自适应**：您可以通过日常语言（比如“我希望稳健一点”或“我能接受高风险”）来调整 Agent 的交易风格，它会根据您的偏好自动控制交易的激进程度。
*   **降低门槛**：让没有专业量化交易背景的中小投资者也能轻松参与到智能交易中来。

**核心技术亮点：**

*   **深度强化学习 (DRL)**：我们使用 DRL 技术训练 Agent，让它像人类学习一样，通过与交易环境的不断互动（试错）来学习最佳的交易决策。
*   **RecurrentPPO (循环策略优化)**：这是一种先进的强化学习算法，特别擅长处理时间序列数据。它赋予了 Agent “记忆”能力，能够记住历史市场走势，从而做出更明智的决策。
*   **自然语言处理 (NLP)**：通过 NLP 技术，我们将您的口头指令（风险偏好）转化为机器能理解的数值，实现人机交互的无缝对接。

**核心技术栈 (使用的工具和库)：**

*   **数据获取与处理**：`yfinance` (下载股票数据), `pandas` (数据处理), `ta` (技术指标计算), `scikit-learn` (数据标准化)。
*   **强化学习环境**：`gymnasium` (构建模拟交易环境)。
*   **DRL 代理训练**：`stable-baselines3` 和 `sb3-contrib` (强化学习算法库，基于 PyTorch)。
*   **NLP 风险解析**：`openai` (通过 DeepSeek API 调用大语言模型)。
*   **数据可视化**：`matplotlib` (绘制交易结果图表)。

---\n

## 2. 项目文件结构与说明：每个文件都是一个“齿轮”

本项目由多个 Python 脚本和数据文件组成，它们协同工作，共同构成了这个智能交易引擎。下面是每个文件和文件夹的详细说明：

```
E:\ai agent量化\
├───AAPL_3y_features.csv      # 原始股票数据经过初步处理和技术指标计算后的文件
├───AAPL_3y_finrl.csv         # 完整、归一化并格式化后的原始股票数据（在处理后会被拆分）
├───AAPL_3y_finrl_train.csv   # **核心**：用于模型训练的数据集
├───AAPL_3y_finrl_val.csv     # **核心**：用于模型验证和回测（评估泛化能力）的数据集
├───custom_trading_env.py     # **核心**：自定义的强化学习交易环境定义
├───delanguage.py             # **核心**：自然语言风险偏好解析模块
├───download_and_process.py   # **核心**：数据下载、处理、特征工程和数据集划分脚本
├───portfolio_value.png       # 验证回测结果的资金曲线图（由validate_agent.py生成）
├───ppo_recurrent_agent.zip   # **核心**：训练好的RecurrentPPO模型文件
├───README.md                 # 您正在阅读的这份详细说明文档
├───requirements.txt          # 项目所有Python依赖库的清单
├───scaler.joblib             # 用于数据特征归一化的Scaler对象（确保数据处理一致性）
├───train_ppo.py              # **核心**：强化学习模型训练脚本
├───validate_agent.py         # **核心**：模型验证和回测脚本
└───__pycache__\              # Python 缓存目录（自动生成，无需关注）
```

**文件功能详解：**

*   **`AAPL_3y_features.csv`**：
    *   **作用**：这是从 `yfinance` 下载的苹果公司 (AAPL) 股票数据，经过初步清洗并计算了各种技术指标（如移动平均线、RSI、MACD等）后的原始文件。它包含了模型学习所需的所有“线索”。
    *   **比喻**：就像一本记录了股票历史价格和各种分析图表的“原始日记本”。

*   **`AAPL_3y_finrl.csv`**：
    *   **作用**：这是 `AAPL_3y_features.csv` 进一步处理后的版本。它的数据格式更适合强化学习环境的输入，并且其中的技术指标已经过“标准化”处理，让模型更容易理解和学习。这个文件是后续训练集和验证集的基础。
    *   **比喻**：就像把“原始日记本”里的内容，整理成了一份机器更容易阅读的“标准化报告”。

*   **`AAPL_3y_finrl_train.csv`**：
    *   **作用**：这是从 `AAPL_3y_finrl.csv` 中划分出来的**训练数据集**。Agent 会反复学习这份数据，从中找出交易规律。它包含了大部分历史数据。
    *   **比喻**：Agent 的“教科书”，它会反复研读这本书来学习知识。

*   **`AAPL_3y_finrl_val.csv`**：
    *   **作用**：这是从 `AAPL_3y_finrl.csv` 中划分出来的**验证数据集**。这份数据是 Agent 在训练过程中从未见过的。我们用它来评估 Agent 的“考试成绩”，看它是否真的学会了泛化能力，而不是死记硬背。
    *   **比喻**：Agent 的“模拟考卷”，用来测试它是否真的掌握了知识，而不是只背了“教科书”里的答案。

*   **`custom_trading_env.py`**：
    *   **作用**：这个文件定义了我们的“模拟交易世界”。它是一个符合 `gymnasium` 标准的强化学习环境。Agent 会在这个环境中进行买卖操作，环境会根据 Agent 的行为和市场变化，给出“奖励”或“惩罚”，并更新市场状态。
    *   **比喻**：Agent 学习和实践的“虚拟沙盘”，它在这里进行无数次模拟交易来提升自己。

*   **`delanguage.py`**：
    *   **作用**：这个文件是连接人类语言和机器指令的“翻译官”。它使用大语言模型（通过 DeepSeek API）将您输入的自然语言风险偏好描述（例如“我希望稳健一点”）转化为一个机器能理解的 0 到 1 之间的数值。
    *   **比喻**：您的“私人翻译”，把您的口头指令精确地传达给 Agent。

*   **`download_and_process.py`**：
    *   **作用**：这个脚本是整个项目的数据“大管家”。它负责从互联网下载最新的股票数据，计算各种技术指标，对数据进行标准化处理，并最终将数据划分为训练集和验证集，为 Agent 的学习和评估做好准备。
    *   **比喻**：一个勤劳的“数据厨师”，负责准备 Agent 学习和考试所需的所有“食材”。

*   **`portfolio_value.png`**：
    *   **作用**：这是一个图片文件，展示了 Agent 在验证集上的投资组合价值随时间变化的曲线图。您可以直观地看到 Agent 的交易表现。
    *   **比喻**：Agent 的“成绩单”，用图表形式展示了它的表现。

*   **`ppo_recurrent_agent.zip`**：
    *   **作用**：这是 Agent 经过大量训练后，学习到的所有“智慧”和“经验”的集合。它是一个压缩文件，包含了 Agent 做出决策所需的所有参数和逻辑。
    *   **比喻**：Agent 的“大脑”，里面存储了它所有的交易智慧。

*   **`README.md`**：
    *   **作用**：您现在正在阅读的这份文档，它详细介绍了整个项目的目的、结构、如何运行以及每个文件的作用。
    *   **比喻**：项目的“使用说明书”和“地图”。

*   **`requirements.txt`**：
    *   **作用**：这个文件列出了运行本项目所需的所有 Python 库和它们的版本。您可以通过它来快速安装所有依赖，确保项目能够顺利运行。
    *   **比喻**：项目的“购物清单”，列出了运行项目所需的所有“工具”。

*   **`scaler.joblib`**：
    *   **作用**：这是一个保存了数据标准化工具的文件。在训练 Agent 之前，我们对数据进行了标准化处理。为了确保在验证和实际使用时，数据也以同样的方式处理，我们需要保存这个工具。
    *   **比喻**：一个“度量衡”，确保所有数据都用统一的标准进行衡量。

*   **`train_ppo.py`**：
    *   **作用**：这个脚本是 Agent 的“训练营”。它会加载 `custom_trading_env.py` 定义的模拟环境和 `AAPL_3y_finrl_train.csv` 训练数据，然后使用 `RecurrentPPO` 算法来训练 Agent，让它变得越来越聪明。
    *   **比喻**：Agent 的“教练”，负责指导 Agent 进行训练，让它掌握交易技能。

*   **`validate_agent.py`**：
    *   **作用**：这个脚本是 Agent 的“考试官”。它会加载训练好的 Agent 大脑 (`ppo_recurrent_agent.zip`)，然后使用 Agent 从未见过的 `AAPL_3y_finrl_val.csv` 验证数据来测试 Agent 的实际表现。它还会根据您的自然语言指令调整 Agent 的风险偏好，并生成回测结果和图表。
    *   **比喻**：Agent 的“考官”，负责检验 Agent 的学习成果，并根据您的要求调整考试难度。

---\n

## 3. 安装与配置：让项目跑起来

在运行项目之前，您需要进行一些简单的设置。

1.  **克隆或下载项目**
    *   首先，将本项目的所有文件下载到您的电脑上。

2.  **创建并激活Python虚拟环境** (强烈推荐)
    *   为了避免不同项目之间Python库的冲突，我们强烈建议您创建一个独立的虚拟环境。
    *   打开您的命令行工具（如 `cmd` 或 `PowerShell`），然后输入以下命令：
        ```bash
        python -m venv venv
        ```
    *   激活虚拟环境：
        *   **Windows 系统**：
            ```bash
            .\venv\Scripts\activate
            ```
        *   **macOS/Linux 系统**：
            ```bash
            source venv/bin/activate
            ```
    *   激活后，您的命令行提示符前面会显示 `(venv)`，表示您已进入虚拟环境。

3.  **安装依赖库**
    *   本项目所需的所有Python库都列在 `requirements.txt` 文件中。在激活虚拟环境后，您只需运行一个命令即可安装所有依赖：
        ```bash
        pip install -r requirements.txt
        ```
    *   **重要提示**：`requirements.txt` 中已锁定 `numpy<2.0` 以确保兼容性。如果遇到 `NumPy` 相关的错误，请确保您的 `NumPy` 版本低于 2.0。

4.  **配置API Key (可选)**
    *   如果您希望使用通过自然语言调整风险偏好的功能（即 `delanguage.py` 模块），您需要配置一个 DeepSeek API Key。
    *   打开 `delanguage.py` 文件，找到以下代码行，并将 `YOUR_DEEPSEEK_API_KEY` 替换为您的真实密钥：
        ```python
        client = OpenAI(
            api_key="YOUR_DEEPSEEK_API_KEY",
            base_url="https://api.deepseek.com"
        )
        ```
    *   如果您暂时没有 API Key，`validate_agent.py` 脚本在运行时会提示您手动输入一个 0 到 1 之间的风险偏好值。

---\n

## 4. 如何运行：三步完成您的第一次AI量化交易

请按照以下顺序执行脚本，来体验完整的AI量化交易流程。

### **第一步：准备“食材” - 下载和处理数据**

*   **目的**：获取最新的股票数据，并将其处理成 Agent 能够理解的格式。
*   **操作**：在您的命令行中运行以下命令：
    ```bash
    python download_and_process.py
    ```
*   **过程**：
    1.  脚本会自动从 `yfinance` 下载苹果公司 (AAPL) 过去三年的股票数据。
    2.  计算多种技术指标（如移动平均线、RSI、MACD等）。
    3.  对这些技术指标进行标准化处理，使其更适合模型学习。
    4.  将处理好的数据划分为**训练集** (`AAPL_3y_finrl_train.csv`) 和**验证集** (`AAPL_3y_finrl_val.csv`)。
*   **产出**：生成 `AAPL_3y_finrl_train.csv` 和 `AAPL_3y_finrl_val.csv` 两个核心数据文件，以及 `scaler.joblib` 标准化工具。

### **第二步：训练“大脑” - 训练AI Agent**

*   **目的**：让 Agent 在历史数据中学习交易策略。
*   **操作**：在您的命令行中运行以下命令：
    ```bash
    python train_ppo.py
    ```
*   **过程**：
    1.  脚本会加载第一步生成的**训练集**数据。
    2.  创建一个模拟交易环境。
    3.  使用 `RecurrentPPO` 算法，让 Agent 在这个环境中进行大量的模拟交易，通过不断试错来学习如何最大化收益。
    4.  训练过程会显示进度条，您可以直观地看到训练进度。
*   **产出**：生成一个名为 `ppo_recurrent_agent.zip` 的文件，这就是我们训练好的 Agent 的“大脑”。

### **第三步：检验“成果” - 验证和回测**

*   **目的**：在 Agent 从未见过的新数据上，测试它的真实表现，并根据您的指令进行交易。
*   **操作**：在您的命令行中运行以下命令：
    ```bash
    python validate_agent.py
    ```
*   **过程**：
    1.  脚本会首先要求您输入您的**风险偏好**（例如：“我希望稳健一点”）。
    2.  `delanguage.py` 模块会将您的自然语言输入转化为一个 0 到 1 之间的风险值。
    3.  脚本会加载第二步训练好的 Agent “大脑” (`ppo_recurrent_agent.zip`) 和第一步生成的**验证集**数据。
    4.  Agent 会根据您的风险偏好，在验证集上进行模拟交易。
    5.  交易完成后，脚本会计算并打印出详细的回测指标，如**累计回报率**、**年化回报率**、**夏普比率**和**最大回撤**。
*   **产出**：
    *   在命令行中输出详细的回测性能报告。
    *   生成一张名为 `portfolio_value.png` 的图片，直观地展示您的资金曲线变化。

---\n

## 5. 工作原理：AI Agent 的决策之旅

1.  **数据驱动**：一切始于数据。`download_and_process.py` 脚本从 `yfinance` 获取原始股价数据（开盘价、最高价、最低价、收盘价、成交量）。
2.  **特征工程**：为了让 Agent 更好地理解市场，我们使用 `ta` 库计算了多种技术指标（如移动平均线、RSI、MACD等），这些指标构成了 Agent 观察市场的“眼睛”。
3.  **数据标准化**：不同技术指标的数值范围差异很大。我们使用 `StandardScaler` 将所有指标都缩放到相似的范围内，这有助于模型更快、更稳定地学习。
4.  **环境构建**：`custom_trading_env.py` 文件构建了一个模拟的股票交易环境。这个环境就像一个游戏世界，Agent 在其中扮演玩家。
5.  **强化学习**：
    *   **观察 (Observation)**：在每个时间点，Agent 会观察当前的市场状态，包括标准化的技术指标、当前的持仓比例和现金比例。
    *   **动作 (Action)**：根据观察到的状态，Agent 的“大脑”（`RecurrentPPO` 模型）会决定执行三个动作之一：**买入 (Buy)**、**卖出 (Sell)** 或 **持有 (Hold)**。
    *   **奖励 (Reward)**：Agent 执行动作后，环境会根据其投资组合价值的变化给出一个“奖励”（如果价值增加）或“惩罚”（如果价值减少）。
    *   **学习 (Learning)**：Agent 的目标是最大化长期累积奖励。它通过 `train_ppo.py` 在训练数据上进行数百万次的模拟交易，不断调整其决策逻辑，以找到最佳的交易策略。
6.  **风险偏好整合**：
    *   在 `validate_agent.py` 中，我们引入了 `delanguage.py` 模块。
    *   您输入的自然语言风险偏好被发送给大语言模型，该模型返回一个 0 到 1 之间的风险值。
    *   这个风险值会直接影响 Agent 在交易时的**仓位大小**。风险值越高，Agent 每次买入或卖出的仓位比例就越大，交易风格也越激进。
7.  **验证与评估**：最后，我们在 Agent 从未见过的验证数据上测试其表现，并生成详细的回测报告和资金曲线图，以评估其泛化能力和盈利潜力。

---\n

## 6. 未来展望与改进方向

本项目为构建一个智能量化交易 Agent 奠定了坚实的基础。未来，我们可以在以下几个方面进行扩展和优化：

*   **多股票支持**：将环境扩展到可以同时交易多只股票，构建一个动态的投资组合。
*   **更复杂的策略**：引入更复杂的动作空间，例如允许 Agent 进行做空、设置止损止盈等操作。
*   **模型优化**：尝试更先进的强化学习算法（如 PPO 的变体、SAC 等），或者使用更复杂的神经网络结构（如 Transformer）来捕捉更长期的市场依赖关系。
*   **实时交易接口**：对接真实的券商 API，实现从模拟到实盘的跨越。
*   **用户界面优化**：开发一个图形用户界面 (GUI)，让用户可以更直观地与 Agent 互动，查看回测结果和实时交易状态。
