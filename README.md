# AI Agent 量化交易项目 (v2.0) - 详细说明文档

## 1. 项目概述：打造您的智能交易助手

本项目旨在构建一个**自适应的 AI Agent 量化交易引擎**。想象一下，您无需复杂的编程知识，只需通过简单的自然语言指令，就能让一个智能机器人帮助您分析市场、制定交易策略，并根据您的风险偏好进行自动交易。

**我们的最终目标是：**

*   **环境感知**：Agent 能够“看懂”市场数据，例如股票价格、技术指标等。
*   **策略生成**：根据市场情况和您的指令，自动生成（或调整）交易策略，例如对冲、套利等方案。
*   **风险自适应**：您可以通过日常语言（比如“我希望稳健一点”或“我能接受高风险”）来调整 Agent 的交易风格，它会根据您的偏好自动控制交易的激进程度。
*   **降低门槛**：让没有专业量化交易背景的中小投资者也能轻松参与到智能交易中来。

**核心技术亮点：**

*   **深度强化学习 (DRL)**：我们使用 DRL 技术训练 Agent，让它像人类学习一样，通过与交易环境的不断互动（试错）来学习最佳的交易决策。
*   **RecurrentPPO (循环策略优化)**：这是一种先进的强化学习算法，特别擅长处理时间序列数据。它赋予了 Agent “记忆”能力，能够记住历史市场走势，从而做出更明智的决策。
*   **自然语言处理 (NLP)**：通过 NLP 技术，我们将您的口头指令（风险偏好）转化为机器能理解的数值，实现人机交互的无缝对接。

**核心技术栈 (使用的工具和库)：**

*   **数据获取与处理**：`yfinance` (下载股票数据), `pandas` (数据处理), `ta` (技术指标计算), `scikit-learn` (数据标准化)。
*   **强化学习环境**：`gymnasium` (构建模拟交易环境)。
*   **DRL 代理训练**：`stable-baselines3` 和 `sb3-contrib` (强化学习算法库，基于 PyTorch)。
*   **NLP 风险解析**：`openai` (通过 DeepSeek API 调用大语言模型)。
*   **数据可视化**：`matplotlib` (绘制交易结果图表)。

---

## 2. 项目文件结构与说明：每个文件都是一个“齿轮”

本项目由多个 Python 脚本和数据文件组成，它们协同工作，共同构成了这个智能交易引擎。下面是每个文件和文件夹的详细说明：

```
E:\ai agent量化\
├───AAPL_3y_features.csv      # 原始股票数据经过初步处理和技术指标计算后的文件
├───AAPL_3y_finrl.csv         # 完整、归一化并格式化后的原始股票数据（在处理后会被拆分）
├───AAPL_3y_finrl_train.csv   # **核心**：用于模型训练的数据集
├───AAPL_3y_finrl_val.csv     # **核心**：用于模型验证和回测（评估泛化能力）的数据集
├───custom_trading_env.py     # **核心**：自定义的强化学习交易环境定义
├───delanguage.py             # **核心**：自然语言风险偏好解析模块
├───download_and_process.py   # **核心**：数据下载、处理、特征工程和数据集划分脚本
├───portfolio_value.png       # 验证回测结果的资金曲线图（由validate_agent.py生成）
├───ppo_recurrent_agent.zip   # **核心**：训练好的RecurrentPPO模型文件
├───README.md                 # 您正在阅读的这份详细说明文档
├───requirements.txt          # 项目所有Python依赖库的清单
├───scaler.joblib             # 用于数据特征归一化的Scaler对象（确保数据处理一致性）
├───train_ppo.py              # **核心**：强化学习模型训练脚本
├───validate_agent.py         # **核心**：模型验证和回测脚本
└───__pycache__\              # Python 缓存目录（自动生成，无需关注）
```

**文件功能详解：**

*   **`AAPL_3y_features.csv`**：
    *   **作用**：这是从 `yfinance` 下载的苹果公司 (AAPL) 股票数据，经过初步清洗并计算了各种技术指标（如移动平均线、RSI、MACD等）后的原始文件。它包含了模型学习所需的所有“线索”。
    *   **比喻**：就像一本记录了股票历史价格和各种分析图表的“原始日记本”。

*   **`AAPL_3y_finrl.csv`**：
    *   **作用**：这是 `AAPL_3y_features.csv` 进一步处理后的版本。它的数据格式更适合强化学习环境的输入，并且其中的技术指标已经过“标准化”处理，让模型更容易理解和学习。这个文件是后续训练集和验证集的基础。
    *   **比喻**：就像把“原始日记本”里的内容，整理成了一份机器更容易阅读的“标准化报告”。

*   **`AAPL_3y_finrl_train.csv`**：
    *   **作用**：这是从 `AAPL_3y_finrl.csv` 中划分出来的**训练数据集**。Agent 会反复学习这份数据，从中找出交易规律。它包含了大部分历史数据。
    *   **比喻**：Agent 的“教科书”，它会反复研读这本书来学习知识。

*   **`AAPL_3y_finrl_val.csv`**：
    *   **作用**：这是从 `AAPL_3y_finrl.csv` 中划分出来的**验证数据集**。这份数据是 Agent 在训练过程中从未见过的。我们用它来评估 Agent 的“考试成绩”，看它是否真的学会了泛化能力，而不是死记硬背。
    *   **比喻**：Agent 的“模拟考卷”，用来测试它是否真的掌握了知识，而不是只背了“教科书”里的答案。

*   **`custom_trading_env.py`**：
    *   **作用**：这个文件定义了我们的“模拟交易世界”。它是一个符合 `gymnasium` 标准的强化学习环境。Agent 会在这个环境中进行买卖操作，环境会根据 Agent 的行为和市场变化，给出“奖励”或“惩罚”，并更新市场状态。
    *   **比喻**：Agent 学习和实践的“虚拟沙盘”，它在这里进行无数次模拟交易来提升自己。

*   **`delanguage.py`**：
    *   **作用**：这个文件是连接人类语言和机器指令的“翻译官”。它使用大语言模型（通过 DeepSeek API）将您输入的自然语言风险偏好描述（例如“我希望稳健一点”）转化为一个机器能理解的 0 到 1 之间的数值。
    *   **比喻**：您的“私人翻译”，把您的口头指令精确地传达给 Agent。

*   **`download_and_process.py`**：
    *   **作用**：这个脚本是整个项目的数据“大管家”。它负责从互联网下载最新的股票数据，计算各种技术指标，对数据进行标准化处理，并最终将数据划分为训练集和验证集，为 Agent 的学习和评估做好准备。
    *   **比喻**：一个勤劳的“数据厨师”，负责准备 Agent 学习和考试所需的所有“食材”。

*   **`portfolio_value.png`**：
    *   **作用**：这是一个图片文件，展示了 Agent 在验证集上的投资组合价值随时间变化的曲线图。您可以直观地看到 Agent 的交易表现。
    *   **比喻**：Agent 的“成绩单”，用图表形式展示了它的表现。

*   **`ppo_recurrent_agent.zip`**：
    *   **作用**：这是 Agent 经过大量训练后，学习到的所有“智慧”和“经验”的集合。它是一个压缩文件，包含了 Agent 做出决策所需的所有参数和逻辑。
    *   **比喻**：Agent 的“大脑”，里面存储了它所有的交易智慧。

*   **`README.md`**：
    *   **作用**：您现在正在阅读的这份文档，它详细介绍了整个项目的目的、结构、如何运行以及每个文件的作用。
    *   **比喻**：项目的“使用说明书”和“地图”。

*   **`requirements.txt`**：
    *   **作用**：这个文件列出了运行本项目所需的所有 Python 库和它们的版本。您可以通过它来快速安装所有依赖，确保项目能够顺利运行。
    *   **比喻**：项目的“购物清单”，列出了运行项目所需的所有“工具”。

*   **`scaler.joblib`**：
    *   **作用**：这是一个保存了数据标准化工具的文件。在训练 Agent 之前，我们对数据进行了标准化处理。为了确保在验证和实际使用时，数据也以同样的方式处理，我们需要保存这个工具。
    *   **比喻**：一个“度量衡”，确保所有数据都用统一的标准进行衡量。

*   **`train_ppo.py`**：
    *   **作用**：这个脚本是 Agent 的“训练营”。它会加载 `custom_trading_env.py` 定义的模拟环境和 `AAPL_3y_finrl_train.csv` 训练数据，然后使用 `RecurrentPPO` 算法来训练 Agent，让它变得越来越聪明。
    *   **比喻**：Agent 的“教练”，负责指导 Agent 进行训练，让它掌握交易技能。

*   **`validate_agent.py`**：
    *   **作用**：这个脚本是 Agent 的“考试官”。它会加载训练好的 Agent 大脑 (`ppo_recurrent_agent.zip`)，然后使用 Agent 从未见过的 `AAPL_3y_finrl_val.csv` 验证数据来测试 Agent 的实际表现。它还会根据您的自然语言指令调整 Agent 的风险偏好，并生成回测结果和图表。
    *   **比喻**：Agent 的“考官”，负责检验 Agent 的学习成果，并根据您的要求调整考试难度。

---

## 3. 安装与配置：让项目跑起来

在运行项目之前，您需要进行一些简单的设置。

1.  **克隆或下载项目**
    *   首先，将本项目的所有文件下载到您的电脑上。

2.  **创建并激活Python虚拟环境** (强烈推荐)
    *   为了避免不同项目之间Python库的冲突，我们强烈建议您创建一个独立的虚拟环境。
    *   打开您的命令行工具（如 `cmd` 或 `PowerShell`），然后输入以下命令：
        ```bash
        python -m venv venv
        ```
    *   激活虚拟环境：
        *   **Windows 系统**：
            ```bash
            .\venv\Scripts\activate
            ```
        *   **macOS/Linux 系统**：
            ```bash
            source venv/bin/activate
            ```
    *   激活后，您的命令行提示符前面会显示 `(venv)` 或 `(ai_trading)`，表示您已进入虚拟环境。

3.  **安装依赖库**
    *   本项目所需的所有Python库都列在 `requirements.txt` 文件中。在激活虚拟环境后，您只需运行一个命令即可安装所有依赖：
        ```bash
        pip install -r requirements.txt
        ```
    *   **重要提示**：`requirements.txt` 中已锁定 `numpy<2.0` 以确保兼容性。如果遇到 `NumPy` 相关的错误，请确保您的 `NumPy` 版本低于 2.0。

4.  **配置API Key (可选)**
    *   如果您希望使用通过自然语言调整风险偏好的功能（即 `delanguage.py` 模块），您需要配置一个 DeepSeek API Key。
    *   打开 `delanguage.py` 文件，找到以下代码行，并将 `